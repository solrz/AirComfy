<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirComfy</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Minimal PWA for ComfyUI workflow execution">
</head>
<body>
    <header>
        <h1>AirComfy</h1>
        <div class="connection-status" id="connectionStatus">Disconnected</div>
    </header>

    <main>
        <!-- Main View -->
        <div id="mainView" class="view">
            <section class="config-section">
                <h2>ComfyUI Configuration</h2>
                <div class="input-group">
                    <label for="serverEndpoint">Server Endpoint:</label>
                    <div class="endpoint-selector">
                        <select id="serverEndpoint" class="endpoint-dropdown">
                            <option value="">Select an endpoint...</option>
                        </select>
                        <button id="manageEndpointsBtn" class="secondary-btn">Manage Endpoints</button>
                    </div>
                </div>
                <button id="connectBtn" class="primary-btn">Connect</button>
            </section>

            <section class="workflow-section">
            <h2>Workflow</h2>
            <div class="workflow-input-area">
                <div class="workflow-status" id="workflowStatus">No workflow loaded</div>
                <div class="workflow-actions">
                    <button id="uploadBtn" class="secondary-btn">
                        üìÅ Upload JSON
                    </button>
                    <button id="pasteBtn" class="secondary-btn">
                        üìã Paste from Clipboard
                    </button>
                    <button id="clearBtn" class="tertiary-btn">Clear</button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
            <div class="workflow-preview" id="workflowPreview" style="display: none;">
                <h3>Workflow Preview</h3>
                <pre id="workflowContent"></pre>
            </div>
            <div class="execution-actions">
                <button id="validateBtn" class="secondary-btn">Validate</button>
                <button id="executeBtn" class="primary-btn" disabled>Execute</button>
            </div>
            </section>

            <section class="results-section">
            <h2>Results</h2>
            <div id="status" class="status-display"></div>
            <div id="progress" class="progress-display"></div>
            <div id="results" class="results-display"></div>
            </section>
        </div>

        <!-- Endpoint Manager View -->
        <div id="endpointManagerView" class="view" style="display: none;">
            <section class="endpoint-manager-section">
                <div class="view-header">
                    <h2>Manage Endpoints</h2>
                    <button id="backToMainBtn" class="secondary-btn">‚Üê Back</button>
                </div>
                
                <div class="endpoint-form">
                    <h3>Add New Endpoint</h3>
                    <div class="input-group">
                        <label for="endpointName">Endpoint Name:</label>
                        <input type="text" id="endpointName" placeholder="e.g., Local Server">
                    </div>
                    <div class="input-group">
                        <label for="endpointUrl">Endpoint URL:</label>
                        <input type="url" id="endpointUrl" placeholder="http://localhost:8188">
                    </div>
                    <button id="addEndpointBtn" class="primary-btn">Add Endpoint</button>
                </div>

                <div class="endpoint-list">
                    <h3>Saved Endpoints</h3>
                    <div id="endpointsList"></div>
                    <p id="noEndpointsMessage" class="no-endpoints-message">No endpoints saved yet.</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        class AirComfy {
            constructor() {
                this.serverUrl = '';
                this.clientId = this.generateClientId();
                this.websocket = null;
                this.currentPromptId = null;
                this.currentWorkflow = null;
                this.endpoints = [];
                this.selectedEndpointId = null;
                this.init();
            }

            init() {
                this.loadEndpoints();
                this.bindEvents();
                this.loadSettings();
                this.registerServiceWorker();
                this.updateEndpointDropdown();
            }

            bindEvents() {
                // Main view events
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('validateBtn').addEventListener('click', () => this.validateWorkflow());
                document.getElementById('executeBtn').addEventListener('click', () => this.executeWorkflow());
                document.getElementById('serverEndpoint').addEventListener('change', (e) => this.selectEndpoint(e.target.value));
                document.getElementById('manageEndpointsBtn').addEventListener('click', () => this.showEndpointManager());

                document.getElementById('uploadBtn').addEventListener('click', () => this.triggerFileUpload());
                document.getElementById('pasteBtn').addEventListener('click', () => this.pasteFromClipboard());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearWorkflow());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));

                // Endpoint manager events
                document.getElementById('backToMainBtn').addEventListener('click', () => this.showMainView());
                document.getElementById('addEndpointBtn').addEventListener('click', () => this.addEndpoint());
            }

            generateClientId() {
                return Math.random().toString(36).substring(2) + Date.now().toString(36);
            }

            loadSettings() {
                const saved = localStorage.getItem('aircomfy-settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    this.selectedEndpointId = settings.selectedEndpointId || null;
                    if (this.selectedEndpointId) {
                        document.getElementById('serverEndpoint').value = this.selectedEndpointId;
                        const endpoint = this.endpoints.find(e => e.id === this.selectedEndpointId);
                        if (endpoint) {
                            this.serverUrl = endpoint.url;
                        }
                    }
                }
            }

            saveSettings() {
                const settings = {
                    selectedEndpointId: this.selectedEndpointId
                };
                localStorage.setItem('aircomfy-settings', JSON.stringify(settings));
            }

            async connect() {
                if (!this.serverUrl) {
                    this.updateStatus('Please select a server endpoint', 'error');
                    return;
                }

                this.saveSettings();

                try {
                    const response = await fetch(`${this.serverUrl}/system_stats`, {
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    if (response.ok) {
                        this.updateConnectionStatus('Connected');
                        this.connectWebSocket();
                        document.getElementById('executeBtn').disabled = false;
                        this.updateStatus('Connected to ComfyUI server', 'success');
                    } else {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                } catch (error) {
                    this.updateConnectionStatus('Disconnected');
                    document.getElementById('executeBtn').disabled = true;

                    if (error.message.includes('fetch') || error.name === 'TypeError') {
                        this.updateStatus(`CORS blocked: Use proxy or serve PWA from ComfyUI server directly`, 'error');
                    } else {
                        this.updateStatus(`Connection failed: ${error.message}`, 'error');
                    }
                }
            }

            connectWebSocket() {
                const wsUrl = this.serverUrl.replace('http', 'ws') + `/ws?clientId=${this.clientId}`;

                if (this.websocket) {
                    this.websocket.close();
                }

                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    this.updateStatus('WebSocket connected', 'success');
                };

                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.websocket.onclose = () => {
                    this.updateStatus('WebSocket disconnected', 'warning');
                };

                this.websocket.onerror = (error) => {
                    this.updateStatus('WebSocket error occurred', 'error');
                };
            }

            handleWebSocketMessage(data) {
                if (data.type === 'status') {
                    this.updateProgress(`Queue: ${data.data.status.exec_info.queue_remaining}`);
                } else if (data.type === 'progress') {
                    const progress = Math.round((data.data.value / data.data.max) * 100);
                    this.updateProgress(`Progress: ${progress}% (${data.data.node})`);
                } else if (data.type === 'executed') {
                    this.handleExecutionComplete(data.data);
                }
            }

            triggerFileUpload() {
                document.getElementById('fileInput').click();
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.endsWith('.json')) {
                    this.updateStatus('Please select a JSON file', 'error');
                    return;
                }

                try {
                    const text = await file.text();
                    this.loadWorkflow(text, `Uploaded: ${file.name}`);
                } catch (error) {
                    this.updateStatus(`Failed to read file: ${error.message}`, 'error');
                }

                event.target.value = '';
            }

            async pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text.trim()) {
                        this.updateStatus('Clipboard is empty', 'error');
                        return;
                    }
                    this.loadWorkflow(text, 'Pasted from clipboard');
                } catch (error) {
                    this.updateStatus('Failed to read clipboard. Use Ctrl+V manually.', 'error');
                }
            }

            loadWorkflow(workflowText, source) {
                try {
                    const workflow = JSON.parse(workflowText);
                    if (typeof workflow !== 'object' || !workflow) {
                        throw new Error('Invalid JSON format');
                    }

                    this.currentWorkflow = workflow;

                    document.getElementById('workflowStatus').textContent = source;
                    document.getElementById('workflowContent').textContent = JSON.stringify(workflow, null, 2);
                    document.getElementById('workflowPreview').style.display = 'block';

                    this.updateStatus('Workflow loaded successfully', 'success');
                } catch (error) {
                    this.updateStatus(`Invalid workflow: ${error.message}`, 'error');
                }
            }

            clearWorkflow() {
                this.currentWorkflow = null;
                document.getElementById('workflowStatus').textContent = 'No workflow loaded';
                document.getElementById('workflowPreview').style.display = 'none';
                this.updateStatus('Workflow cleared', 'info');
            }

            validateWorkflow() {
                if (!this.currentWorkflow) {
                    this.updateStatus('Please load a workflow first', 'error');
                    return false;
                }

                try {
                    if (typeof this.currentWorkflow !== 'object' || !this.currentWorkflow) {
                        throw new Error('Invalid workflow format');
                    }
                    this.updateStatus('Workflow validation passed', 'success');
                    return true;
                } catch (error) {
                    this.updateStatus(`Workflow validation failed: ${error.message}`, 'error');
                    return false;
                }
            }

            async executeWorkflow() {
                if (!this.validateWorkflow()) return;
                if (!this.serverUrl) {
                    this.updateStatus('Please connect to server first', 'error');
                    return;
                }

                const promptData = {
                    prompt: this.currentWorkflow,
                    client_id: this.clientId
                };

                try {
                    this.updateStatus('Submitting workflow...', 'info');
                    const response = await fetch(`${this.serverUrl}/prompt`, {
                        method: 'POST',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(promptData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.currentPromptId = result.prompt_id;
                        this.updateStatus(`Workflow submitted. Prompt ID: ${this.currentPromptId}`, 'success');
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }
                } catch (error) {
                    this.updateStatus(`Execution failed: ${error.message}`, 'error');
                }
            }

            async handleExecutionComplete(data) {
                if (data.prompt_id === this.currentPromptId) {
                    this.updateStatus('Workflow execution completed', 'success');
                    this.updateProgress('Complete');

                    try {
                        const historyResponse = await fetch(`${this.serverUrl}/history/${this.currentPromptId}`, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        if (historyResponse.ok) {
                            const history = await historyResponse.json();
                            this.displayResults(history);
                        }
                    } catch (error) {
                        this.updateStatus(`Failed to fetch results: ${error.message}`, 'error');
                    }
                }
            }

            displayResults(history) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';

                for (const [promptId, promptData] of Object.entries(history)) {
                    if (promptData.outputs) {
                        for (const [nodeId, nodeOutput] of Object.entries(promptData.outputs)) {
                            if (nodeOutput.images) {
                                nodeOutput.images.forEach(image => {
                                    const img = document.createElement('img');
                                    img.src = `${this.serverUrl}/view?filename=${image.filename}&subfolder=${image.subfolder}&type=${image.type}`;
                                    img.alt = `Generated image from node ${nodeId}`;
                                    img.className = 'result-image';
                                    resultsDiv.appendChild(img);
                                });
                            }
                        }
                    }
                }

                if (resultsDiv.innerHTML === '') {
                    resultsDiv.innerHTML = '<p>No images generated</p>';
                }
            }

            updateConnectionStatus(status) {
                const element = document.getElementById('connectionStatus');
                element.textContent = status;
                element.className = `connection-status ${status.toLowerCase()}`;
            }

            updateStatus(message, type = 'info') {
                const element = document.getElementById('status');
                element.textContent = message;
                element.className = `status-display ${type}`;
            }

            updateProgress(message) {
                document.getElementById('progress').textContent = message;
            }

            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('./sw.js');
                    } catch (error) {
                        console.warn('Service Worker registration failed');
                    }
                }
            }

            // Endpoint Management Functions
            loadEndpoints() {
                const saved = localStorage.getItem('aircomfy-endpoints');
                if (saved) {
                    this.endpoints = JSON.parse(saved);
                } else {
                    // Add default endpoint
                    this.endpoints = [
                        {
                            id: this.generateEndpointId(),
                            name: 'Local Server',
                            url: 'http://localhost:8188'
                        }
                    ];
                    this.saveEndpoints();
                }
            }

            saveEndpoints() {
                localStorage.setItem('aircomfy-endpoints', JSON.stringify(this.endpoints));
            }

            generateEndpointId() {
                return 'endpoint-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            }

            showEndpointManager() {
                document.getElementById('mainView').style.display = 'none';
                document.getElementById('endpointManagerView').style.display = 'block';
                this.renderEndpointsList();
            }

            showMainView() {
                document.getElementById('endpointManagerView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
                this.updateEndpointDropdown();
            }

            selectEndpoint(endpointId) {
                const endpoint = this.endpoints.find(e => e.id === endpointId);
                if (endpoint) {
                    this.selectedEndpointId = endpointId;
                    this.serverUrl = endpoint.url;
                    this.saveSettings();
                    this.updateConnectionStatus('Disconnected');
                    document.getElementById('executeBtn').disabled = true;
                } else {
                    this.selectedEndpointId = null;
                    this.serverUrl = '';
                }
            }

            updateEndpointDropdown() {
                const select = document.getElementById('serverEndpoint');
                const currentValue = select.value;
                
                // Clear existing options except the first placeholder
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add endpoints
                this.endpoints.forEach(endpoint => {
                    const option = document.createElement('option');
                    option.value = endpoint.id;
                    option.textContent = `${endpoint.name} (${endpoint.url})`;
                    select.appendChild(option);
                });
                
                // Restore selected value if it still exists
                if (currentValue && this.endpoints.find(e => e.id === currentValue)) {
                    select.value = currentValue;
                } else if (this.selectedEndpointId && this.endpoints.find(e => e.id === this.selectedEndpointId)) {
                    select.value = this.selectedEndpointId;
                }
            }

            addEndpoint() {
                const name = document.getElementById('endpointName').value.trim();
                const url = document.getElementById('endpointUrl').value.trim();
                
                if (!name || !url) {
                    alert('Please enter both name and URL for the endpoint');
                    return;
                }
                
                try {
                    new URL(url); // Validate URL format
                } catch (e) {
                    alert('Please enter a valid URL');
                    return;
                }
                
                const endpoint = {
                    id: this.generateEndpointId(),
                    name: name,
                    url: url
                };
                
                this.endpoints.push(endpoint);
                this.saveEndpoints();
                this.renderEndpointsList();
                
                // Clear form
                document.getElementById('endpointName').value = '';
                document.getElementById('endpointUrl').value = '';
            }

            deleteEndpoint(endpointId) {
                if (confirm('Are you sure you want to delete this endpoint?')) {
                    this.endpoints = this.endpoints.filter(e => e.id !== endpointId);
                    this.saveEndpoints();
                    
                    // Clear selection if deleted endpoint was selected
                    if (this.selectedEndpointId === endpointId) {
                        this.selectedEndpointId = null;
                        this.serverUrl = '';
                        this.saveSettings();
                    }
                    
                    this.renderEndpointsList();
                }
            }

            editEndpoint(endpointId) {
                const endpoint = this.endpoints.find(e => e.id === endpointId);
                if (endpoint) {
                    const newName = prompt('Enter new name:', endpoint.name);
                    if (newName && newName.trim()) {
                        const newUrl = prompt('Enter new URL:', endpoint.url);
                        if (newUrl && newUrl.trim()) {
                            try {
                                new URL(newUrl); // Validate URL format
                                endpoint.name = newName.trim();
                                endpoint.url = newUrl.trim();
                                this.saveEndpoints();
                                
                                // Update server URL if this endpoint is selected
                                if (this.selectedEndpointId === endpointId) {
                                    this.serverUrl = endpoint.url;
                                }
                                
                                this.renderEndpointsList();
                            } catch (e) {
                                alert('Please enter a valid URL');
                            }
                        }
                    }
                }
            }

            renderEndpointsList() {
                const listContainer = document.getElementById('endpointsList');
                const noEndpointsMessage = document.getElementById('noEndpointsMessage');
                
                if (this.endpoints.length === 0) {
                    listContainer.innerHTML = '';
                    noEndpointsMessage.style.display = 'block';
                    return;
                }
                
                noEndpointsMessage.style.display = 'none';
                listContainer.innerHTML = '';
                
                this.endpoints.forEach(endpoint => {
                    const endpointItem = document.createElement('div');
                    endpointItem.className = 'endpoint-item';
                    endpointItem.innerHTML = `
                        <div class="endpoint-info">
                            <div class="endpoint-name">${endpoint.name}</div>
                            <div class="endpoint-url">${endpoint.url}</div>
                        </div>
                        <div class="endpoint-actions">
                            <button class="icon-btn edit-btn" title="Edit" data-id="${endpoint.id}">‚úèÔ∏è</button>
                            <button class="icon-btn delete-btn" title="Delete" data-id="${endpoint.id}">üóëÔ∏è</button>
                        </div>
                    `;
                    listContainer.appendChild(endpointItem);
                });
                
                // Add event listeners to edit and delete buttons
                listContainer.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.editEndpoint(e.target.dataset.id);
                    });
                });
                
                listContainer.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.deleteEndpoint(e.target.dataset.id);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new AirComfy();
        });
    </script>
</body>
</html>