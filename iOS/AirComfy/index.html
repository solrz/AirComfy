<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirComfy</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Minimal PWA for ComfyUI workflow execution">
</head>
<body>
    <header>
        <h1>AirComfy</h1>
        <div class="connection-status" id="connectionStatus">Disconnected</div>
    </header>

    <main>
        <section class="config-section">
            <h2>ComfyUI Configuration</h2>
            <div class="input-group">
                <label for="serverUrl">Server URL:</label>
                <input type="url" id="serverUrl" placeholder="http://192.168.11.132:8188" value="http://192.168.11.132:8188">
            </div>
            <button id="connectBtn" class="primary-btn">Connect</button>
        </section>

        <section class="workflow-section">
            <h2>Workflow</h2>
            <div class="workflow-input-area">
                <div class="workflow-status" id="workflowStatus">No workflow loaded</div>
                <div class="workflow-actions">
                    <button id="uploadBtn" class="secondary-btn">
                        üìÅ Upload JSON
                    </button>
                    <button id="pasteBtn" class="secondary-btn">
                        üìã Paste from Clipboard
                    </button>
                    <button id="testBtn" class="secondary-btn">
                        üß™ Load Test Workflow
                    </button>
                    <button id="clearBtn" class="tertiary-btn">Clear</button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
            <div class="workflow-preview" id="workflowPreview" style="display: none;">
                <h3>Workflow Preview</h3>
                <pre id="workflowContent"></pre>
            </div>
            <div class="execution-actions">
                <button id="validateBtn" class="secondary-btn">Validate</button>
                <button id="executeBtn" class="primary-btn" disabled>Execute</button>
            </div>
        </section>

        <section class="results-section">
            <h2>Results</h2>
            <div id="status" class="status-display"></div>
            <div id="progress" class="progress-display"></div>
            <div id="results" class="results-display"></div>
        </section>
    </main>

    <script>
        class AirComfy {
            constructor() {
                this.serverUrl = '';
                this.clientId = this.generateClientId();
                this.websocket = null;
                this.currentPromptId = null;
                this.currentWorkflow = null;
                this.isIOSApp = window.webkit && window.webkit.messageHandlers;
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadSettings();
                this.registerServiceWorker();
            }

            bindEvents() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('validateBtn').addEventListener('click', () => this.validateWorkflow());
                document.getElementById('executeBtn').addEventListener('click', () => this.executeWorkflow());
                document.getElementById('serverUrl').addEventListener('input', (e) => this.saveSettings());

                document.getElementById('uploadBtn').addEventListener('click', () => this.triggerFileUpload());
                document.getElementById('pasteBtn').addEventListener('click', () => this.pasteFromClipboard());
                document.getElementById('testBtn').addEventListener('click', () => this.loadTestWorkflow());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearWorkflow());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
            }

            generateClientId() {
                return Math.random().toString(36).substring(2) + Date.now().toString(36);
            }

            loadSettings() {
                const saved = localStorage.getItem('aircomfy-settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    document.getElementById('serverUrl').value = settings.serverUrl || 'http://192.168.11.132:8188';
                }
            }

            saveSettings() {
                const settings = {
                    serverUrl: document.getElementById('serverUrl').value
                };
                localStorage.setItem('aircomfy-settings', JSON.stringify(settings));
            }

            getProxiedUrl(url) {
                if (this.isIOSApp) {
                    return url.replace('http://', 'comfyproxy://').replace('https://', 'comfyproxy://');
                }
                return url;
            }

            async connect() {
                const serverUrl = document.getElementById('serverUrl').value.trim();
                if (!serverUrl) {
                    this.updateStatus('Please enter a server URL', 'error');
                    return;
                }

                this.serverUrl = serverUrl;
                this.saveSettings();

                try {
                    const fetchUrl = this.getProxiedUrl(`${this.serverUrl}/system_stats`);
                    const response = await fetch(fetchUrl, {
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    if (response.ok) {
                        this.updateConnectionStatus('Connected');
                        this.connectWebSocket();
                        document.getElementById('executeBtn').disabled = false;
                        this.updateStatus('Connected to ComfyUI server', 'success');
                    } else {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                } catch (error) {
                    this.updateConnectionStatus('Disconnected');
                    document.getElementById('executeBtn').disabled = true;

                    if (error.message.includes('fetch') || error.name === 'TypeError') {
                        this.updateStatus(this.isIOSApp ? `Connection failed: ${error.message}` : `CORS blocked: Use proxy or serve PWA from ComfyUI server directly`, 'error');
                    } else {
                        this.updateStatus(`Connection failed: ${error.message}`, 'error');
                    }
                }
            }

            connectWebSocket() {
                if (this.isIOSApp) {
                    this.updateStatus('Using polling for iOS (WebSocket not supported)', 'info');
                    return;
                }

                const wsUrl = this.serverUrl.replace('http', 'ws') + `/ws?clientId=${this.clientId}`;

                if (this.websocket) {
                    this.websocket.close();
                }

                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    this.updateStatus('WebSocket connected', 'success');
                };

                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.websocket.onclose = () => {
                    this.updateStatus('WebSocket disconnected', 'warning');
                };

                this.websocket.onerror = (error) => {
                    this.updateStatus('WebSocket error occurred', 'error');
                };
            }

            handleWebSocketMessage(data) {
                if (data.type === 'status') {
                    this.updateProgress(`Queue: ${data.data.status.exec_info.queue_remaining}`);
                } else if (data.type === 'progress') {
                    const progress = Math.round((data.data.value / data.data.max) * 100);
                    this.updateProgress(`Progress: ${progress}% (${data.data.node})`);
                } else if (data.type === 'executed') {
                    this.handleExecutionComplete(data.data);
                }
            }

            triggerFileUpload() {
                document.getElementById('fileInput').click();
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.endsWith('.json')) {
                    this.updateStatus('Please select a JSON file', 'error');
                    return;
                }

                try {
                    const text = await file.text();
                    this.loadWorkflow(text, `Uploaded: ${file.name}`);
                } catch (error) {
                    this.updateStatus(`Failed to read file: ${error.message}`, 'error');
                }

                event.target.value = '';
            }

            async pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text.trim()) {
                        this.updateStatus('Clipboard is empty', 'error');
                        return;
                    }
                    this.loadWorkflow(text, 'Pasted from clipboard');
                } catch (error) {
                    this.updateStatus('Failed to read clipboard. Use Ctrl+V manually.', 'error');
                }
            }

            loadTestWorkflow() {
                const testWorkflow = {
                    "3": {
                        "inputs": {
                            "seed": 156680208700286,
                            "steps": 20,
                            "cfg": 8,
                            "sampler_name": "euler",
                            "scheduler": "normal",
                            "denoise": 1,
                            "model": ["4", 0],
                            "positive": ["6", 0],
                            "negative": ["7", 0],
                            "latent_image": ["5", 0]
                        },
                        "class_type": "KSampler",
                        "_meta": { "title": "KÈááÊ†∑Âô®" }
                    },
                    "4": {
                        "inputs": { "ckpt_name": "v1-5-pruned-emaonly.safetensors" },
                        "class_type": "CheckpointLoaderSimple",
                        "_meta": { "title": "CheckpointÂä†ËΩΩÂô®ÔºàÁÆÄÊòìÔºâ" }
                    },
                    "5": {
                        "inputs": { "width": 512, "height": 512, "batch_size": 1 },
                        "class_type": "EmptyLatentImage",
                        "_meta": { "title": "Á©∫LatentÂõæÂÉè" }
                    },
                    "6": {
                        "inputs": {
                            "text": "beautiful scenery nature glass bottle landscape, , purple galaxy bottle,",
                            "clip": ["4", 1]
                        },
                        "class_type": "CLIPTextEncode",
                        "_meta": { "title": "CLIPÊñáÊú¨ÁºñÁ†Å" }
                    },
                    "7": {
                        "inputs": {
                            "text": "text, watermark",
                            "clip": ["4", 1]
                        },
                        "class_type": "CLIPTextEncode",
                        "_meta": { "title": "CLIPÊñáÊú¨ÁºñÁ†Å" }
                    },
                    "8": {
                        "inputs": {
                            "samples": ["3", 0],
                            "vae": ["4", 2]
                        },
                        "class_type": "VAEDecode",
                        "_meta": { "title": "VAEËß£Á†Å" }
                    },
                    "9": {
                        "inputs": {
                            "filename_prefix": "ComfyUI",
                            "images": ["8", 0]
                        },
                        "class_type": "SaveImage",
                        "_meta": { "title": "‰øùÂ≠òÂõæÂÉè" }
                    }
                };

                this.loadWorkflow(JSON.stringify(testWorkflow), 'Test workflow (SD15-basicT2I)');
            }

            loadWorkflow(workflowText, source) {
                try {
                    const workflow = JSON.parse(workflowText);
                    if (typeof workflow !== 'object' || !workflow) {
                        throw new Error('Invalid JSON format');
                    }

                    this.currentWorkflow = workflow;

                    document.getElementById('workflowStatus').textContent = source;
                    document.getElementById('workflowContent').textContent = JSON.stringify(workflow, null, 2);
                    document.getElementById('workflowPreview').style.display = 'block';

                    this.updateStatus('Workflow loaded successfully', 'success');
                } catch (error) {
                    this.updateStatus(`Invalid workflow: ${error.message}`, 'error');
                }
            }

            clearWorkflow() {
                this.currentWorkflow = null;
                document.getElementById('workflowStatus').textContent = 'No workflow loaded';
                document.getElementById('workflowPreview').style.display = 'none';
                this.updateStatus('Workflow cleared', 'info');
            }

            validateWorkflow() {
                if (!this.currentWorkflow) {
                    this.updateStatus('Please load a workflow first', 'error');
                    return false;
                }

                try {
                    if (typeof this.currentWorkflow !== 'object' || !this.currentWorkflow) {
                        throw new Error('Invalid workflow format');
                    }
                    this.updateStatus('Workflow validation passed', 'success');
                    return true;
                } catch (error) {
                    this.updateStatus(`Workflow validation failed: ${error.message}`, 'error');
                    return false;
                }
            }

            async executeWorkflow() {
                if (!this.validateWorkflow()) return;
                if (!this.serverUrl) {
                    this.updateStatus('Please connect to server first', 'error');
                    return;
                }

                const promptData = {
                    prompt: this.currentWorkflow,
                    client_id: this.clientId
                };

                try {
                    this.updateStatus('Submitting workflow...', 'info');
                    console.log('Sending workflow:', promptData);
                    const response = await fetch(this.getProxiedUrl(`${this.serverUrl}/prompt`), {
                        method: 'POST',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(promptData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.currentPromptId = result.prompt_id;
                        console.log('Workflow submitted with prompt ID:', this.currentPromptId);
                        this.updateStatus(`Workflow submitted. Prompt ID: ${this.currentPromptId}`, 'success');

                        if (this.isIOSApp) {
                            this.startPolling();
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Server error response:', errorText);
                        throw new Error(`Server error: ${response.status} - ${errorText}`);
                    }
                } catch (error) {
                    console.error('Execution failed:', error);
                    this.updateStatus(`Execution failed: ${error.message}`, 'error');
                }
            }

            async handleExecutionComplete(data) {
                if (data.prompt_id === this.currentPromptId) {
                    this.updateStatus('Workflow execution completed', 'success');
                    this.updateProgress('Complete');

                    try {
                        const historyResponse = await fetch(this.getProxiedUrl(`${this.serverUrl}/history/${this.currentPromptId}`), {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        if (historyResponse.ok) {
                            const history = await historyResponse.json();
                            this.displayResults(history);
                        }
                    } catch (error) {
                        this.updateStatus(`Failed to fetch results: ${error.message}`, 'error');
                    }
                }
            }

            displayResults(history) {
                console.log('displayResults called with:', history);
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';

                for (const [promptId, promptData] of Object.entries(history)) {
                    if (promptData.outputs) {
                        for (const [nodeId, nodeOutput] of Object.entries(promptData.outputs)) {
                            if (nodeOutput.images) {
                                nodeOutput.images.forEach(image => {
                                    const img = document.createElement('img');
                                    const imageUrl = `${this.serverUrl}/view?filename=${image.filename}&subfolder=${image.subfolder}&type=${image.type}`;
                                    img.src = this.getProxiedUrl(imageUrl);
                                    img.alt = `Generated image from node ${nodeId}`;
                                    img.className = 'result-image';
                                    img.onerror = () => {
                                        console.log(`Failed to load image: ${img.src}`);
                                        img.alt = 'Failed to load image';
                                    };
                                    console.log(`Adding image: ${img.src}`);
                                    resultsDiv.appendChild(img);
                                });
                            }
                        }
                    }
                }

                if (resultsDiv.innerHTML === '') {
                    resultsDiv.innerHTML = '<p>No images generated</p>';
                }
            }

            updateConnectionStatus(status) {
                const element = document.getElementById('connectionStatus');
                element.textContent = status;
                element.className = `connection-status ${status.toLowerCase()}`;
            }

            updateStatus(message, type = 'info') {
                const element = document.getElementById('status');
                element.textContent = message;
                element.className = `status-display ${type}`;
            }

            updateProgress(message) {
                document.getElementById('progress').textContent = message;
            }

            startPolling() {
                if (!this.currentPromptId) return;

                console.log('Starting polling for prompt ID:', this.currentPromptId);
                this.updateProgress('Polling for results...');

                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(this.getProxiedUrl(`${this.serverUrl}/history/${this.currentPromptId}`), {
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (response.ok) {
                            const history = await response.json();
                            console.log('Polling response:', history);

                            if (history && Object.keys(history).length > 0) {
                                clearInterval(pollInterval);
                                this.updateStatus('Workflow execution completed', 'success');
                                this.updateProgress('Complete');
                                this.displayResults(history);
                            }
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                        this.updateProgress('Polling...');
                    }
                }, 2000);

                setTimeout(() => {
                    clearInterval(pollInterval);
                    this.updateStatus('Polling timeout - check results manually', 'warning');
                }, 60000);
            }

            async registerServiceWorker() {
                if (!this.isIOSApp && 'serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('./sw.js');
                    } catch (error) {
                        console.warn('Service Worker registration failed');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new AirComfy();
        });
    </script>
</body>
</html>